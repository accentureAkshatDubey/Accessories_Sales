version: 0.0.63
jobId: "736"
jobName: Accessories Sales
jobType: Source Aligned Data Product
alias: Ingesting_data_into_athena
discoveryPort:
  name: Accessories Sales
inputPorts:
  - alias: PH_ENQ_1
    isDynamic: true
    path: s3://msil-data-lake-raw/dms/muldms/master/full/ph_enq/
    optional:
      persistDataFrame: false
      advanceOptions:
        mergeSchema: true
      enableDataReconciliation: false
      enforceSchema: false
      connection: Digital Sales S3 Connectivity
      dataSetUrn: urn:dv:dataset:9e6f0763-1c4f-494f-bdbe-523a844d06f9
    type: inputParquet
  - alias: PD_ENQ_1
    isDynamic: true
    path: s3://msil-data-lake-raw/dms/muldms/master/full/pd_enq/
    optional:
      persistDataFrame: false
      advanceOptions:
        mergeSchema: true
      enableDataReconciliation: false
      enforceSchema: false
      connection: Digital Sales S3 Connectivity
      dataSetUrn: urn:dv:dataset:7bf0bd5e-a850-4e34-8a8b-e8db98a05f33
    type: inputParquet
  - alias: PD_ISSUE_1
    isDynamic: true
    path: s3://msil-data-lake-raw/dms/muldms/transaction/*/pd_issue/pd_issue_2023_*.parquet
    optional:
      persistDataFrame: false
      advanceOptions:
        mergeSchema: false
      enableDataReconciliation: false
      enforceSchema: false
      connection: Digital Sales S3 Connectivity
      dataSetUrn: urn:dv:dataset:4a3840bf-87c0-4455-a4ad-a280e7ab0b5d
    type: inputParquet
  - alias: PM_ACC_CATG_MAST__1
    isDynamic: true
    path: s3://msil-data-lake-raw/dms/muldms/master/full/pm_acc_catg_mast/
    optional:
      persistDataFrame: false
      advanceOptions:
        mergeSchema: true
      enableDataReconciliation: false
      enforceSchema: false
      connection: Digital Sales S3 Connectivity
      dataSetUrn: urn:dv:dataset:86e13999-b4e3-4d6a-ba69-73bb4f7ff7d3
    type: inputParquet
  - alias: AM_LIST_1
    isDynamic: true
    path: s3://msil-data-lake-raw/dms/muldms/master/full/am_list/
    optional:
      persistDataFrame: false
      advanceOptions:
        mergeSchema: true
      enableDataReconciliation: false
      enforceSchema: false
      connection: Market Quality S3 Connectivity
      dataSetUrn: urn:dv:dataset:cc3bbf9a-a967-4358-9b6f-6ffa5cf95cb6
    type: inputParquet
productState:
  isDynamic: true
  alias: Ingesting_data_into_athena
  retentionVersions: ""
  logicalSchema:
    properties:
      item_value:
        type: STRING
        description: item value
      PD_ISSUE_PARENT_GROUP:
        type: STRING
        description: Parent group from pd issue
      PD_ISSUE_DEALER_MAP_CD:
        type: STRING
        description: Dealer map code from pd issue
      PD_ISSUE_LOC_CD:
        type: STRING
        description: location code from pd issue
      PD_ISSUE_DOC_NUM:
        type: STRING
        description: Doc number from pd_issue
      PD_ISSUE_PART_NUM:
        type: STRING
        description: Part number from pd issue
      PD_ENQ_PARENT_GROUP:
        type: STRING
        description: Parent group from pd_enq
      PD_ENQ_DEALER_MAP_CD:
        type: STRING
        description: Dealer map code from pd_enq
      PD_ENQ_LOC_CD:
        type: STRING
        description: Location code from pd enq
      PD_ENQ_INVOICE_NUM:
        type: STRING
        description: Invoice number from pd enq
      PD_ENQ_part_num:
        type: STRING
        description: Part number from pd enq
      PH_ENQ_PARENT_GROUP:
        type: STRING
        description: Parent group from ph enq
      PH_ENQ_DEALER_MAP_CD:
        type: STRING
        description: Dealer Map Code from ph enq
      PH_ENQ_LOC_CD:
        type: STRING
        description: Location code from ph enq
      PH_ENQ_ENQ_NUM:
        type: STRING
        description: Enquiry number from ph enq
      PH_ENQ_ENQ_SOURCE:
        type: STRING
        description: Enquiry source from ph_enq
      PH_ENQ_ENQ_MOD:
        type: STRING
        description: Enquiry mode from ph enq
      PH_ENQ_INVOICE_NUM:
        type: STRING
        description: Invoice number from ph enq
      PH_ENQ_INVOICE_DATE:
        type: DATETIME
        description: Invoice date from ph enq
      PH_ENQ_ENQ_DATE:
        type: DATETIME
        description: Enquiry date from ph enq
      PH_ENQ_CUST_REMARKS:
        type: STRING
        description: Customer remarks from ph enq
      PH_ENQ_CUST_PHONE:
        type: STRING
        description: Customer phone number from ph enq
      PH_ENQ_CUST_NAME:
        type: STRING
        description: Customer name from ph enq
      PH_ENQ_CUST_STATE:
        type: STRING
        description: Customer state from ph enq
      status:
        type: STRING
        description: Status from pd enq
      enq_status:
        type: STRING
        description: enquiry status from ph enq
      part_category:
        type: STRING
        description: part category from pd enq
      PART_LMS_DATE:
        type: DATETIME
        description: Part lms date from ph enq
      part_qty:
        type: STRING
        description: Part quantity from pd enq
      etl_inserted_date:
        type: DATETIME
        description: ETL pipeline data insert date
      etl_modified_date:
        type: DATETIME
        description: ETL pipeline modification date
      etl_created_by:
        type: STRING
        description: ETL pipeline created by
      etl_updated_by:
        type: STRING
        description: ETL pipeline updated by
  stateStoreType: loadDataIceberg
  isProfilingEnabled: false
  updateStrategy: Overwrite
  tableName: msil_transformed_layer.Accessories_Sales
  warehousePath: s3://dlp-platform-engine-bucket/
  catalogName: glue
  optional:
    persistDataFrame: false
    enableDataReconciliation: false
    enforceSchema: false
    enforceSchemaMethod: Warning
    catalogType: glue
  refreshInterval: 0 10 * * *
transformation:
  - alias: Spark_SQL_2
    type: SQL
    description: Data Creation
    query: select DISTINCT
      item_value,PART_NUM,DOC_TYPE,LOC_CD,COMP_FA,DOC_NUM,SRL_NUM,PARENT_GROUP,DEALER_MAP_CD,nvl(modified_date,created_date)
      as date_check from pd_issue_raw
    sequenceNo: 6
    references:
      - alias: PD_ISSUE_1
        sqlReference: pd_issue_raw
  - alias: Refresh_Data_1
    type: ""
    description: Refresh PD_issue data
    sequenceNo: 7
  - alias: Spark_SQL_1
    type: SQL
    description: transformation logic for accessories sales
    query: SELECT    distinct c.item_value as item_value,    c.PARENT_GROUP AS
      PD_ISSUE_PARENT_GROUP,    c.DEALER_MAP_CD AS
      PD_ISSUE_DEALER_MAP_CD,    c.LOC_CD AS PD_ISSUE_LOC_CD,    c.DOC_NUM AS
      PD_ISSUE_DOC_NUM,    c.PART_NUM AS PD_ISSUE_PART_NUM,    b.PARENT_GROUP AS
      PD_ENQ_PARENT_GROUP,    b.DEALER_MAP_CD AS
      PD_ENQ_DEALER_MAP_CD,    b.LOC_CD AS PD_ENQ_LOC_CD,    b.INVOICE_NUM AS
      PD_ENQ_INVOICE_NUM,    b.PART_NUM as PD_ENQ_part_num,    a.PARENT_GROUP as
      PH_ENQ_PARENT_GROUP,    a.DEALER_MAP_CD AS
      PH_ENQ_DEALER_MAP_CD,    a.LOC_CD AS PH_ENQ_LOC_CD,    a.ENQ_NUM AS
      PH_ENQ_ENQ_NUM,    a.ENQ_SOURCE AS PH_ENQ_ENQ_SOURCE,    a.ENQ_MODE AS
      PH_ENQ_ENQ_MOD,    a.INVOICE_NUM AS PH_ENQ_INVOICE_NUM,    a.INVOICE_DATE
      AS PH_ENQ_INVOICE_DATE,    a.ENQ_DATE AS PH_ENQ_ENQ_DATE,    a.CUST_STATE
      AS PH_ENQ_CUST_STATE,    a.CUST_PHONE AS PH_ENQ_CUST_PHONE,    concat_ws
      (     ' ', A.CUST_FNAME, A.CUST_MNAME, A.CUST_LNAME   ) AS
      PH_ENQ_CUST_NAME,    a.CUST_REMARKS AS PH_ENQ_CUST_REMARKS,    b.status AS
      status,    a.enq_status AS enq_status,    b.part_category as
      part_category,    a.PART_LMS_DATE AS
      Parts_First_Followup_Date,    b.part_qty as
      part_qty,    a.ENQ_ORDERREADINESS_DATE as
      Order_Readiness_Date,   x.list_desc as header_status,   y.CATG_DESC as
      Product_Category,   b.PART_QTY as Parts_Enquiry_Quantity,    x.list_desc
      as Line_wise_status,   a.part_num as Part num
      enquired,   current_timestamp() as
      etl_inserted_date,    current_timestamp() as
      etl_modified_date,    'platform_admin' as
      etl_created_by,    'platform_admin' as etl_updated_by  from    PH_ENQ
      a    inner JOIN PD_ENQ b ON concat (     a.PARENT_GROUP, '|',
      cast(a.DEALER_MAP_CD as string),      '|', a.LOC_CD, '|', a.ENQ_NUM   ) =
      concat (     b.PARENT_GROUP, '|', cast(b.DEALER_MAP_CD as
      string),      '|', b.LOC_CD, '|', b.ENQ_NUM   )    inner JOIN PD_ISSUE c
      ON concat (     c.PARENT_GROUP, '|', cast(c.DEALER_MAP_CD as
      string),      '|', c.LOC_CD, '|', c.DOC_NUM, '|',      c.PART_NUM   ) =
      concat (     b.PARENT_GROUP, '|', cast(b.DEALER_MAP_CD as
      string,      '|', b.LOC_CD, '|', b.INVOICE_NUM,      '|',
      b.PART_NUM   )  inner join pm_acc_catg_mast y on b.part_category =
      y.catg_type inner join am_list x on a.enq_status = x.list_code
      WHERE    LEFT(a.ENQ_NUM, 3) = 'ACC'    and lower(a.enq_mode) in ('web',
      'order', 'orde','mwb')    and lower(a.CUST_REMARKS) not like
      '%suzuki%connet%'    and lower(cust_email) not in (     '%@maruti.co.in',
      '%@adglobal360.com'   and x.LIST_NAME='ACC_HDR_ENQ_STATUS' )
    sequenceNo: 8
    references:
      - alias: PH_ENQ_1
        sqlReference: PH_ENQ
      - alias: PD_ENQ_1
        sqlReference: PD_ENQ
      - alias: Refresh_Data_1
        sqlReference: PD_ISSUE
      - alias: PM_ACC_CATG_MAST__1
        sqlReference: PM_ACC_CATG_MAST
      - alias: AM_LIST_1
        sqlReference: AM_LIST
controlPort:
  dataQualityRules:
    RecordCountCheck:
      productState:
        expression: ">="
        number: 1
        referenceAlias: Ingesting_data_into_athena
outputPort:
  subscriptionChannels:
    - channelType: Postgres
      queryType: SQL
